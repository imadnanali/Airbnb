<% layout ("/layouts/boilerplate")%>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <!-- Back navigation -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <a href="/listings" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Listings
                </a>
                <h1 class="h3 mb-0 text-center flex-grow-1">Property Details</h1>
                <div style="width: 130px;"></div>
            </div>

            <!-- Main card -->
            <div class="card shadow-sm overflow-hidden">
                <!-- Image section with overlay -->
                <div class="position-relative">
                    <img src="<%= listing.image ? listing.image : 'https://images.unsplash.com/photo-1586810724476-c294fb7ac01b?q=80&w=436&auto=format&fit=crop&ixlib=rb-4.1.0' %>"
                        class="card-img-top property-img" alt="<%= listing.title %>">
                    <div class="property-price-overlay">
                        <h3 class="text-white mb-0">â‚¹<%= listing.price %><small class="fs-6">/night</small></h3>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Title and location -->
                    <h2 class="card-title h3 mb-2">
                        <%= listing.title %>
                    </h2>
                    <p class="card-text text-muted mb-3">
                        <i class="fas fa-map-marker-alt text-primary me-2"></i>
                        <%= listing.location %>, <%= listing.country %>
                    </p>

                    <!-- Description -->
                    <h4 class="h5 mb-3">Description</h4>
                    <p class="card-text mb-4">
                        <%= listing.description %>
                    </p>

                    <!-- Amenities -->
                    <h4 class="h5 mb-3">Amenities</h4>
                    <div class="row mb-4">
                        <div class="col-6 col-md-4 mb-2">
                            <span><i class="fas fa-wifi text-primary me-2"></i> High-speed WiFi</span>
                        </div>
                        <div class="col-6 col-md-4 mb-2">
                            <span><i class="fas fa-parking text-primary me-2"></i> Free parking</span>
                        </div>
                        <div class="col-6 col-md-4 mb-2">
                            <span><i class="fas fa-snowflake text-primary me-2"></i> Air conditioning</span>
                        </div>
                        <div class="col-6 col-md-4 mb-2">
                            <span><i class="fas fa-tv text-primary me-2"></i> Smart TV</span>
                        </div>
                        <div class="col-6 col-md-4 mb-2">
                            <span><i class="fas fa-utensils text-primary me-2"></i> Fully equipped kitchen</span>
                        </div>
                        <div class="col-6 col-md-4 mb-2">
                            <span><i class="fas fa-swimming-pool text-primary me-2"></i> Swimming pool access</span>
                        </div>
                    </div>
                </div>

                <!-- Action buttons -->
                <div class="d-flex flex-wrap gap-3 my-2 mx-2 pt-4 border-top">
                    <a class="btn btn-primary px-4" href="/listings/<%= listing._id %>/edit">
                        <i class="fas fa-edit me-2"></i>Edit Listing
                    </a>

                    <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="d-inline">
                        <button class="btn btn-outline-danger px-4">
                            <i class="fas fa-trash me-2"></i>Delete
                        </button>
                    </form>

                    <a href="#" class="btn btn-success px-4 ms-md-auto">
                        <i class="fas fa-calendar-check me-2"></i>Book Now
                    </a>
                </div>
            </div>

            <!-- Review Form -->
            <div class="card shadow-sm mt-5">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-edit me-2"></i>Leave a Review</h4>
                </div>
                <div class="card-body">
                    <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation">
                        <!-- PlayStore Style Star Rating -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Rating</label>
                            <div class="star-rating mb-3">
                                <div class="stars-container" id="starsContainer">
                                    <input type="hidden" id="ratingValue" name="review[rating]" value="3" required>
                                    <div class="d-flex justify-content-center">
                                        <% for (let i = 1; i <= 5; i++) { %>
                                            <i class="star-icon far fa-star fa-2x mx-1" data-rating="<%= i %>"></i>
                                        <% } %>
                                    </div>
                                </div>
                                <div class="text-center mt-2">
                                    <span id="ratingText" class="text-muted">Tap to rate: 3 stars - Good</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comment Input -->
                        <div class="mb-4">
                            <label for="comment" class="form-label fw-bold">Your Review</label>
                            <textarea required class="form-control" id="comment" name="review[comment]" 
                                      rows="5" placeholder="Share your experience..."></textarea>
                            <div class="invalid-feedback">Please provide your review comments.</div>
                            <div class="form-text">Your detailed review helps others make better decisions.</div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>Submit Review
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Reviews Display -->
            <div class="mt-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">Customer Reviews</h3>
                    <% if (listing.reviews && listing.reviews.length > 0) { %>
                        <span class="badge bg-primary rounded-pill"><%= listing.reviews.length %> reviews</span>
                    <% } %>
                </div>
                
                <% if (listing.reviews && listing.reviews.length > 0) { %>
                    <!-- Review Stats -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4 border-end">
                                    <h2 class="text-primary mb-0">
                                        <% 
                                            const totalRating = listing.reviews.reduce((sum, review) => sum + review.rating, 0);
                                            const averageRating = (totalRating / listing.reviews.length).toFixed(1);
                                        %>
                                        <%= averageRating %>
                                    </h2>
                                    <div class="stars mb-1">
                                        <% for (let i = 1; i <= 5; i++) { %>
                                            <% if (i <= averageRating) { %>
                                                <i class="fas fa-star text-warning"></i>
                                            <% } else if (i - averageRating < 1) { %>
                                                <i class="fas fa-star-half-alt text-warning"></i>
                                            <% } else { %>
                                                <i class="far fa-star text-warning"></i>
                                            <% } %>
                                        <% } %>
                                    </div>
                                    <small class="text-muted">Average Rating</small>
                                </div>
                                <div class="col-md-8">
                                    <h6 class="mb-3">Rating Distribution</h6>
                                    <% for (let i = 5; i >= 1; i--) { %>
                                        <% 
                                            const ratingCount = listing.reviews.filter(r => r.rating === i).length;
                                            const percentage = ratingCount / listing.reviews.length * 100;
                                        %>
                                        <div class="row align-items-center mb-2">
                                            <div class="col-2 text-end">
                                                <span class="text-muted"><%= i %> <i class="fas fa-star text-warning"></i></span>
                                            </div>
                                            <div class="col-8">
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-warning" role="progressbar" 
                                                         style="width: percentage">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-2">
                                                <small class="text-muted"><%= ratingCount %></small>
                                            </div>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Individual Reviews -->
                    <div class="reviews-list">
                        <% listing.reviews.forEach(review => { %>
                            <div class="card mb-3">
                                <div class="card-body position-relative">
                                    <!-- Delete Button - Top Right Corner -->
                                    <form action="/listings/<%=listing._id%>/reviews/<%=review._id%>?_method=DELETE" method="POST" class="position-absolute" style="top: 40px; right: 15px;">
                                        <button type="submit" class="btn btn-outline-danger btn-sm" 
                                                onclick="return confirm('Are you sure you want to delete this review?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                    
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="stars">
                                            <% for (let i = 1; i <= 5; i++) { %>
                                                <% if (i <= review.rating) { %>
                                                    <i class="fas fa-star text-warning"></i>
                                                <% } else { %>
                                                    <i class="far fa-star text-warning"></i>
                                                <% } %>
                                            <% } %>
                                            <span class="ms-2 fw-bold text-dark"><%= review.rating %>.0</span>
                                        </div>
                                        <small class="text-muted">
                                            <% if (review.createdAt) { %>
                                                <%= review.createdAt.toLocaleDateString() %>
                                            <% } else { %>
                                                Recently
                                            <% } %>
                                        </small>
                                    </div>
                                    <p class="mb-0"><%= review.comment %></p>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                <% } else { %>
                    <!-- No Reviews Message -->
                    <div class="text-center py-5">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Reviews Yet</h4>
                        <p class="text-muted">Be the first to share your experience!</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<style>
    .property-img {
        height: 450px;
        object-fit: cover;
        width: 100%;
    }

    .property-price-overlay {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 8px;
    }

    .card {
        border: none;
        border-radius: 12px;
    }

    .btn {
        border-radius: 8px;
        font-weight: 500;
    }

    .btn-primary {
        background: linear-gradient(135deg, #2c3e50, #1a2530);
        border: none;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #1a2530, #2c3e50);
        transform: translateY(-2px);
    }

    /* PlayStore Style Star Rating */
    .star-icon {
        cursor: pointer;
        transition: all 0.2s ease;
        color: #ddd;
    }

    .star-icon:hover {
        transform: scale(1.2);
    }

    .star-icon.active {
        color: #ffc107;
    }

    .star-rating {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #e9ecef;
    }

    /* Delete button styling */
    .btn-outline-danger.btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-outline-danger.btn-sm:hover {
        background-color: #dc3545;
        color: white;
        transform: scale(1.1);
    }
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
    // PlayStore Style Star Rating
    document.addEventListener('DOMContentLoaded', function() {
        const stars = document.querySelectorAll('.star-icon');
        const ratingValue = document.getElementById('ratingValue');
        const ratingText = document.getElementById('ratingText');
        
        const ratingTexts = {
            1: "1 star - Poor",
            2: "2 stars - Fair", 
            3: "3 stars - Good",
            4: "4 stars - Very Good",
            5: "5 stars - Excellent"
        };
        
        // Initialize with default rating
        setRating(3);
        
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                setRating(rating);
            });
            
            star.addEventListener('mouseover', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                highlightStars(rating);
            });
        });
        
        // Reset to selected rating when mouse leaves stars container
        document.getElementById('starsContainer').addEventListener('mouseleave', function() {
            const currentRating = parseInt(ratingValue.value);
            highlightStars(currentRating);
        });
        
        function setRating(rating) {
            ratingValue.value = rating;
            highlightStars(rating);
            ratingText.textContent = `Tap to rate: ${ratingTexts[rating]}`;
        }
        
        function highlightStars(rating) {
            stars.forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                if (starRating <= rating) {
                    star.classList.remove('far');
                    star.classList.add('fas', 'active');
                } else {
                    star.classList.remove('fas', 'active');
                    star.classList.add('far');
                }
            });
        }
    });
</script>